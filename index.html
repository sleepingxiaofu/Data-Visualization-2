<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Education Access and Equity in Malaysia</title>
    
    <!-- Vega Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/vega@5.22.1"></script>
    <script src="https://cdn.jsdelivr.net/npm/vega-lite@5.6.0"></script>
    <script src="https://cdn.jsdelivr.net/npm/vega-embed@6.21.0"></script>
    
    <!-- Google Fonts - Playfair Display for main heading -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        /* Typography and Base Styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            line-height: 1.6;
            color: #2C4A6B;
            background-color: #f7f7f7;
        }
        
        /* Serif fonts for titles */
        h1, h2, h3, h4 {
            font-family: 'Georgia', 'Times New Roman', serif;
            font-weight: 400;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 20px;
        }
        
        /* Header with Display Font */
        header {
            background: linear-gradient(135deg, #53a8e1 0%, #afd3e7 100%);
            color: white;
            padding: 80px 0;
            text-align: center;
        }
        
        header h1 {
            font-family: 'Playfair Display', Georgia, serif; /* Display font - RUBRIC */
            font-size: 4em; /* Increased from 3.2em */
            font-weight: 700; /* Bolder - RUBRIC */
            margin-bottom: 15px;
            letter-spacing: -1px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1); /* Added shadow */
        }
        
        header p {
            font-size: 1.2em;
            font-weight: 300;
            opacity: 0.9;
            max-width: 600px;
            margin: 0 auto;
        }
        
        /* Stats Cards */
        .stats-section {
            background: white;
            padding: 60px 0;
            margin-top: -40px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(44, 74, 107, 0.1);
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 30px;
            margin-bottom: 20px;
        }
        
        .stat-card {
            background: #fdcd8c;
            padding: 40px 30px;
            border-radius: 8px;
            text-align: center;
            color: #2C4A6B;
            border: 1px solid #d0bbdb;
        }
        
        .stat-value {
            font-family: 'Georgia', serif;
            font-size: 2.8em;
            font-weight: 400;
            display: block;
            margin-bottom: 8px;
            color: #2C4A6B;
        }
        
        .stat-label {
            font-size: 0.9em;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: #2C4A6B;
            opacity: 0.8;
        }
        
        /* Section Styles */
        section {
            background: white;
            margin: 40px 0; /* Reduced from 50px - LAYOUT */
            padding: 60px;
            border-radius: 8px;
            border: 1px solid #d0bbdb;
        }
        
        section h2 {
            font-size: 2.2em;
            color: #2C4A6B;
            margin-bottom: 30px;
            font-weight: 300;
            letter-spacing: -0.5px;
        }
        
        section h3 {
            font-size: 1.6em;
            color: #2C4A6B;
            margin: 40px 0 20px 0;
            font-weight: 300;
        }
        
        /* Two Panel Layout */
        .two-panel {
            display: grid;
            grid-template-columns: 2fr 3fr;
            gap: 60px;
            align-items: start;
        }
        
        .content-panel {
            padding-right: 20px;
        }
        
        .viz-panel {
            position: relative;
        }
        
        /* Content Styles */
        .section-intro {
            font-size: 1.05em; /* Slightly reduced */
            color: #2C4A6B;
            line-height: 1.7; /* Tighter */
            margin-bottom: 30px;
        }
        
        /* Interactive Controls */
        .controls {
            background: #fdcd8c;
            padding: 25px;
            margin: 25px 0;
            border-radius: 8px;
            border: 1px solid #d0bbdb;
        }
        
        .controls h4 {
            margin-bottom: 18px;
            color: #2C4A6B;
            font-size: 1.1em;
        }
        
        .button-group {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }
        
        .control-btn {
            padding: 10px 20px;
            background: white;
            border: 1px solid #afd3e7;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9em;
            color: #2C4A6B;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        
        .control-btn:hover, .control-btn.active {
            background: #53a8e1;
            color: white;
            border-color: #53a8e1;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            transform: translateY(-2px);
        }

        /* Slider styles */
        .slider-container {
            width: 100%;
            margin-top: 15px;
            display: flex;
            align-items: center;
            gap: 15px;
            color: #2C4A6B;
        }

        .slider-container label {
            font-weight: 600;
            min-width: 100px;
            font-size: 0.95em;
        }

        .slider {
            appearance: none;
            width: 100%;
            height: 10px;
            border-radius: 5px;  
            background: #d0bbdb;
            outline: none;
            opacity: 0.8;
            -webkit-transition: .2s;
            transition: opacity .2s;
        }

        .slider:hover {
            opacity: 1;
        }

        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%; 
            background: #53a8e1;
            cursor: pointer;
            border: 2px solid white;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        .slider::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #53a8e1;
            cursor: pointer;
            border: 2px solid white;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        #income-min-value, #slider-year-value {
            font-weight: 700;
            color: #53a8e1;
            min-width: 60px;
            text-align: right;
        }
        
        /* Visualization Containers */
        .viz-container {
            margin: 0;
            padding: 30px;
            background: white;
            border-radius: 8px;
            border: 1px solid #d0bbdb;
        }
        
        .viz-title {
            font-family: 'Georgia', serif;
            font-size: 1.4em;
            font-weight: 400;
            color: #2C4A6B;
            margin-bottom: 12px;
        }
        
        .viz-description {
            font-size: 0.9em; /* Reduced slightly */
            color: #53a8e1;
            margin-bottom: 25px;
            line-height: 1.5; /* Tighter */
        }
        
        /* Insights Box - REDUCED TEXT */
        .insight-box {
            background: #afd3e7;
            padding: 25px; /* Reduced from 30px */
            margin: 30px 0;
            border-radius: 8px;
            border-left: 4px solid #53a8e1;
        }
        
        .insight-box h4 {
            color: #2C4A6B;
            margin-bottom: 15px; /* Reduced from 18px */
            font-size: 1.2em; /* Slightly reduced */
            font-weight: 400;
        }
        
        .insight-box ul {
            list-style: none;
            color: #2C4A6B;
        }
        
        .insight-box li {
            margin: 10px 0; /* Reduced from 12px */
            padding-left: 20px;
            position: relative;
            font-size: 0.95em; /* Slightly smaller text */
        }
        
        .insight-box li:before {
            content: "•";
            color: #53a8e1;
            font-weight: bold;
            position: absolute;
            left: 0;
        }
        
        /* Three Column Layout */
        .three-col-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 30px;
            align-items: start;
        }

        /* Two Column Layout for Scatters */
        .two-col-scatter-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            align-items: start;
        }
        
        /* Alert styles */
        .alert {
            padding: 20px; /* Reduced from 25px */
            margin: 20px 0;
            border-radius: 8px;
            font-weight: 400;
            line-height: 1.6;
            font-size: 0.95em; /* Slightly smaller */
        }
        
        .alert-warning {
            background: #fca3a3;
            color: white;
        }
        
        .alert-success {
            background: #53a8e1;
            color: white;
        }
        
        .alert-info {
            background: #afd3e7;
            color: #2C4A6B;
        }
        
        /* Single column for mobile */
        .single-col {
            display: block;
        }
        
        /* Footer with Metadata - RUBRIC */
        footer {
            background: #2C4A6B;
            color: white;
            padding: 40px 0; /* Reduced from 50px */
            text-align: center;
            margin-top: 60px; /* Reduced from 80px */
        }
        
        footer p {
            margin: 10px 0;
            opacity: 0.9;
            line-height: 1.6;
            font-size: 0.95em;
        }

        footer a {
            color: #afd3e7;
            text-decoration: none;
            border-bottom: 1px dotted #afd3e7;
        }

        footer a:hover {
            color: white;
            border-bottom-color: white;
        }
        
        /* Responsive adjustments */
        @media (max-width: 1024px) {
            .two-panel {
                grid-template-columns: 1fr;
                gap: 40px;
            }
            
            .content-panel {
                padding-right: 0;
            }

            .two-col-scatter-grid {
                grid-template-columns: 1fr;
            }
        }
        
        @media (max-width: 768px) {
            header h1 {
                font-size: 2.5em; /* Responsive */
            }
            
            section {
                padding: 40px 30px;
            }
            
            .three-col-grid {
                grid-template-columns: 1fr;
            }
            
            .stat-card {
                padding: 30px 20px;
            }
            
            .stat-value {
                font-size: 2.2em;
            }

            .viz-container {
                padding: 20px;
            }
        }

        /* Extra small devices (phones, 480px and down) */
        @media (max-width: 480px) {
            header h1 {
                font-size: 1.8em;
            }

            header p {
                font-size: 1em;
            }

            section {
                padding: 30px 15px;
            }

            section h2 {
                font-size: 1.6em;
            }

            .viz-container {
                padding: 15px;
            }

            .viz-title {
                font-size: 1.1em;
            }

            .controls {
                padding: 15px;
            }

            .button-group {
                flex-direction: column;
            }

            .control-btn {
                width: 100%;
            }

            /* Make map height responsive on mobile */
            #vis-enhanced-map {
                height: 400px;
            }
        }
        
        /* Vega embed adjustments */
        .vega-embed {
            width: 100% !important;
        }
        
        .vega-embed details {
            display: none !important;
        }

        /* Ensure canvas and SVG use full width */
        #vis-enhanced-map, #vis-efficiency-scatter, #vis-teacher-pressure,
        #vis-timeline, #vis-gender-pipeline, #vis-ethnicity, #vis-age-structure {
            width: 100%;
        }

        #vis-enhanced-map canvas, #vis-enhanced-map svg,
        #vis-efficiency-scatter canvas, #vis-efficiency-scatter svg,
        #vis-teacher-pressure canvas, #vis-teacher-pressure svg,
        #vis-timeline canvas, #vis-timeline svg,
        #vis-gender-pipeline canvas, #vis-gender-pipeline svg,
        #vis-ethnicity canvas, #vis-ethnicity svg,
        #vis-age-structure canvas, #vis-age-structure svg {
            width: 100% !important;
            height: auto !important;
        }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <h1>Education Access and Equity in Malaysia</h1>
            <p>Infrastructure, Resources, and Socioeconomic Context Across Malaysian States</p>
        </div>
    </header>
    
    <div class="container">
        
        <!-- Executive Summary - REDUCED TEXT -->
        <section>
            <h2>Executive Summary</h2>
            <div class="section-intro">
                Analysis of Malaysia's education system reveals critical disparities in infrastructure, resources, and outcomes across 16 states, highlighting urban-rural divides and demographic shifts.
            </div>
            
            <div class="three-col-grid">
                <div class="alert alert-warning">
                    <strong>Urban Teacher Crisis:</strong> Selangor and Kuala Lumpur face severe shortages (15.7 students/teacher) despite highest incomes.
                </div>
                <div class="alert alert-success">
                    <strong>Female Education Shift:</strong> Women now comprise 57.3% of post-secondary enrollment, indicating major demographic transition.
                </div>
            </div>
        </section>
        
        <!-- Interactive Map Section -->
        <section>
            <h2>Interactive Education-Economic Geography</h2>
            <div class="section-intro">
                Explore how wealth, poverty, and education resources distribute across Malaysia.
            </div>
            
            <div class="controls">
                <h4>Map Layer Controls</h4>
                <div class="button-group">
                    <button class="control-btn active" data-layer="schools">Schools per 10k Population</button>
                    <button class="control-btn" data-layer="income">Average Monthly Income</button>
                    <button class="control-btn" data-layer="poverty">Poverty Rate</button>
                </div>
            </div>

            <div class="controls">
                <h4>Zoom Controls</h4>
                <div class="button-group">
                    <button class="control-btn zoom-btn active" data-zoom="all">All Malaysia</button>
                    <button class="control-btn zoom-btn" data-zoom="peninsular">Peninsular Malaysia</button>
                    <button class="control-btn zoom-btn" data-zoom="east">East Malaysia</button>
                </div>
            </div>
            
            <div class="viz-container">
                <div class="viz-title">Education Infrastructure Distribution by State, Malaysia 2022</div>
                <div class="viz-description">Choropleth map with ocean background and graticule. Hover for state details.</div>
                <div id="vis-enhanced-map"></div>
            </div>
            
            <div class="insight-box">
                <h4>Geographic Insights</h4>
                <ul>
                    <li><strong>Urban-Rural Divide:</strong> Sarawak has 4.5x more schools per capita than Selangor</li>
                    <li><strong>High-Need Areas:</strong> Sabah combines high poverty (19.7%) with moderate capacity</li>
                    <li><strong>Wealth Paradox:</strong> Richest states have lowest education infrastructure per capita</li>
                </ul>
            </div>
        </section>

        <!-- Resource Allocation Section - WITH INCOME FILTER -->
        <section>
            <h2>Resource Allocation & Teacher Distribution</h2>
            <div class="section-intro">
                Resource allocation efficiency and teacher distribution patterns reveal economic disparities and pressure points.
            </div>
            
            <!-- Income Filter Slider - NEW for RUBRIC -->
            <div class="controls">
                <h4>Filter by Income Range</h4>
                <div class="slider-container">
                    <label>Minimum Income:</label>
                    <input type="range" min="4000" max="13000" value="4000" step="500"
                           class="slider" id="income-min-slider">
                    <span id="income-min-value">RM 4,000</span>
                </div>
            </div>
            
            <div class="two-col-scatter-grid">
                <div>
                    <div class="viz-container">
                        <div class="viz-title">Education Resources vs Economic Status</div>
                        <div class="viz-description">Bubble size = poverty level. Filter with slider above.</div>
                        <div id="vis-efficiency-scatter"></div>
                    </div>
                    <div class="insight-box">
                        <h4>Resource Efficiency</h4>
                        <ul>
                            <li><strong>Overperformers:</strong> Kelantan delivers good access despite low income</li>
                            <li><strong>Urban Constraints:</strong> Wealthy states struggle with capacity</li>
                            <li><strong>Sabah Priority:</strong> Needs both economic and education support</li>
                        </ul>
                    </div>
                </div>
                
                <div>
                    <div class="viz-container">
                        <div class="viz-title">Teacher Distribution Pressure Index</div>
                        <div class="viz-description">Student-teacher ratios with economic context.</div>
                        <div id="vis-teacher-pressure"></div>
                    </div>
                    <div class="insight-box">
                        <h4>Teacher Distribution</h4>
                        <ul>
                            <li><strong>Federal Territory Crisis:</strong> Severe shortages in urban centers</li>
                            <li><strong>Rural Advantage:</strong> Better ratios in lower-density states</li>
                            <li><strong>Policy Opportunity:</strong> Apply rural models to urban areas</li>
                        </ul>
                    </div>
                </div>
            </div>
        </section>
        
        <!-- Temporal Analysis Section - REDUCED TEXT -->
        <section>
            <h2>Temporal Analysis and Trends</h2>
            <div class="two-panel">
                <div class="content-panel">
                    <div class="section-intro">
                        Track Malaysia's education evolution from 2017-2022 to identify emerging challenges.
                    </div>
                    
                    <div class="controls">
                        <h4>Select Year</h4>
                        <div class="slider-container">
                            <label for="year-slider">Year:</label>
                            <input type="range" min="2017" max="2022" value="2022" class="slider" id="year-slider">
                            <span id="slider-year-value">2022</span>
                        </div>
                    </div>
                    
                    <div class="insight-box">
                        <h4>Temporal Trends</h4>
                        <ul>
                            <li><strong>Stable Primary:</strong> ~2.77M students maintained</li>
                            <li><strong>Post-Secondary Growth:</strong> 18% increase 2017-2022</li>
                            <li><strong>Urban Deterioration:</strong> Teacher ratios worsening</li>
                        </ul>
                    </div>
                </div>
                
                <div class="viz-panel">
                    <div class="viz-container">
                        <div class="viz-title">Multi-Metric Education Timeline</div>
                        <div class="viz-description">Filter by year using the slider above.</div>
                        <div id="vis-timeline"></div>
                    </div>
                </div>
            </div>
        </section>
        
        <!-- Demographics Section - REDUCED TEXT -->
        <section>
            <h2>Demographic Analysis</h2>
            
            <div class="single-col">
                <div class="section-intro">
                    Gender, ethnicity, and age patterns shape education demand and outcomes.
                </div>
            </div>
            
            <div class="three-col-grid">
                <div class="viz-container">
                    <div class="viz-title">Gender Progression Pipeline</div>
                    <div class="viz-description">Gender balance shifts through stages.</div>
                    <div id="vis-gender-pipeline"></div>
                </div>
                
                <div class="viz-container">
                    <div class="viz-title">Ethnic Representation</div>
                    <div class="viz-description">Student demographics across groups.</div>
                    <div id="vis-ethnicity"></div>
                </div>
                
                <div class="viz-container">
                    <div class="viz-title">Age Distribution Impact</div>
                    <div class="viz-description">Population structure effects.</div>
                    <div id="vis-age-structure"></div>
                </div>
            </div>
            
            <div class="insight-box">
                <h4>Demographic Insights</h4>
                <ul>
                    <li><strong>Female Dominance:</strong> 57.3% post-secondary indicates workforce transformation</li>
                    <li><strong>Young Population:</strong> States with youth require more primary infrastructure</li>
                    <li><strong>Ethnic Diversity:</strong> Greater diversity in urban vs. rural areas</li>
                </ul>
            </div>
        </section>
        
        <!-- Policy Recommendations - CONDENSED -->
        <section>
            <h2>Policy Recommendations</h2>
            
            <h3>Immediate Priorities (2024-2025)</h3>
            <div class="three-col-grid">
                <div class="alert alert-warning">
                    <strong>Urban Teacher Recruitment:</strong>
                    Target 3,000 additional teachers for Selangor, KL, and Putrajaya.
                </div>
                <div class="alert alert-info">
                    <strong>Infrastructure Investment:</strong>
                    Fast-track school construction in high-growth urban districts.
                </div>
                <div class="alert alert-success">
                    <strong>Rural Model Replication:</strong>
                    Study successful models from Perlis and Terengganu.
                </div>
            </div>
            
            <h3>Medium-term Strategy (2025-2027)</h3>
            <ul style="margin-left: 30px; line-height: 1.7;">
                <li><strong>Teacher Incentives:</strong> Higher pay, housing assistance for urban postings</li>
                <li><strong>Digital Solutions:</strong> Technology to supplement urban teacher shortages</li>
                <li><strong>Gender Research:</strong> Study post-secondary gap for workforce planning</li>
            </ul>
            
            <h3>Long-term Vision (2027-2030)</h3>
            <ul style="margin-left: 30px; line-height: 1.7;">
                <li>Achieve ≤12:1 teacher-student ratios in all urban centers</li>
                <li>Integrated education-economic plans for high-poverty states</li>
                <li>National education equity index for monitoring</li>
            </ul>
        </section>
    </div>
    
    <!-- Footer with Metadata - RUBRIC REQUIREMENT -->
    <footer>
        <div class="container">
            <p><strong>Author:</strong> shanwu zhang | <strong>Unit:</strong> FIT3179 Data Visualisation 2 | <strong>Date:</strong> October 2025</p>
            <p><strong>Data Sources:</strong> 
                <!-- should add the links here -->
            </p>
            
            <!-- <p style="margin-top: 20px; font-size: 0.85em; opacity: 0.7;">
                Monash University Malaysia | ©2025
            </p> -->
        </div>
    </footer>
    
    
    
    <script>
        // Color Palette
        const colorSchemes = {
            lightBlue: "#afd3e7",
            mediumBlue: "#53a8e1",
            darkBlue: "#2C79A8",
            veryDarkBlue: "#1a4d6b",
            lightRed: "#fca3a3",
            mediumRed: "#ed5f5f",
            darkRed: "#d62828",
            lightOrange: "#fef5e7",
            mediumOrange: "#fcd8c7",
            darkOrange: "#ffa74f",
            veryDarkOrange: "#ff6b35",
            lightPurple: "#d0bbdb",
            mediumPurple: "#9a72c7",
            textDark: "#2C4A6B"
        };
        
        // Enhanced map data
        const enhancedMapData = [
            {state: "Selangor", schools_per_10k: 2564, income_mean: 12233, poverty: 1.5},
            {state: "Kuala Lumpur", schools_per_10k: 2844, income_mean: 13325, poverty: 1.4},
            {state: "Putrajaya", schools_per_10k: 4489, income_mean: 13473, poverty: 0.1},
            {state: "Pulau Pinang", schools_per_10k: 4432, income_mean: 8267, poverty: 2.0},
            {state: "Labuan", schools_per_10k: 5556, income_mean: 8250, poverty: 2.5},
            {state: "Johor", schools_per_10k: 5704, income_mean: 8517, poverty: 4.6},
            {state: "Melaka", schools_per_10k: 6055, income_mean: 8057, poverty: 4.2},
            {state: "Kelantan", schools_per_10k: 6322, income_mean: 4885, poverty: 13.2},
            {state: "Kedah", schools_per_10k: 6791, income_mean: 5550, poverty: 9.0},
            {state: "Sabah", schools_per_10k: 6932, income_mean: 6171, poverty: 19.7},
            {state: "Perlis", schools_per_10k: 7075, income_mean: 5664, poverty: 4.0},
            {state: "Negeri Sembilan", schools_per_10k: 7742, income_mean: 6788, poverty: 4.4},
            {state: "Terengganu", schools_per_10k: 8245, income_mean: 7248, poverty: 6.2},
            {state: "Perak", schools_per_10k: 8609, income_mean: 5779, poverty: 7.5},
            {state: "Pahang", schools_per_10k: 8896, income_mean: 5777, poverty: 6.3},
            {state: "Sarawak", schools_per_10k: 11589, income_mean: 6457, poverty: 10.8}
        ];
        
        let currentMapLayer = 'schools';
        let currentMinIncome = 4000; // For scatter filter
        let currentZoom = 'all'; // For zoom controls
        
        // Enhanced interactive map with RUBRIC requirements
        function createEnhancedMap() {
            // Get zoom settings based on current zoom level
            const getZoomSettings = () => {
                switch(currentZoom) {
                    case 'all':
                        return {"center": [109, 4.2], "scale": 2800};
                    case 'peninsular':
                        return {"center": [102, 4.0], "scale": 4500};
                    case 'east':
                        return {"center": [115, 4.0], "scale": 4000};
                    default:
                        return {"center": [109, 4.2], "scale": 2800};
                }
            };
            
            const zoomSettings = getZoomSettings();
            const getColorField = (layer) => {
                switch(layer) {
                    case 'schools': return 'schools_per_10k';
                    case 'income': return 'income_mean';
                    case 'poverty': return 'poverty';
                    default: return 'schools_per_10k';
                }
            };
            
            // DISCRETE COLOR SCALES - RUBRIC - Using Threshold
            const getColorScale = (layer) => {
                switch(layer) {
                    case 'schools': 
                        return {
                            "type": "threshold",
                            "domain": [4000, 6000, 8000, 10000],
                            "range": ["#e8f4f8", "#afd3e7", "#53a8e1", "#2C79A8", "#1a4d6b"]
                        };
                    case 'income': 
                        return {
                            "type": "threshold",
                            "domain": [6000, 8000, 10000, 12000],
                            "range": ["#fef5e7", "#fcd8c7", "#ffa74f", "#ff8c42", "#ff6b35"]
                        };
                    case 'poverty': 
                        return {
                            "type": "threshold",
                            "domain": [2, 5, 10, 15],
                            "range": ["#e8f4f8", "#fcd8c7", "#fca3a3", "#ed5f5f", "#d62828"]
                        };
                    default: 
                        return {
                            "type": "threshold",
                            "domain": [4000, 6000, 8000, 10000],
                            "range": ["#e8f4f8", "#afd3e7", "#53a8e1", "#2C79A8", "#1a4d6b"]
                        };
                }
            };
            
            const getLegendTitle = (layer) => {
                switch(layer) {
                    case 'schools': return 'Schools per 10,000';
                    case 'income': return 'Avg Income (RM)';
                    case 'poverty': return 'Poverty Rate (%)';
                    default: return 'Schools per 10,000';
                }
            };
            
            const mapSpec = {
                "$schema": "https://vega.github.io/schema/vega-lite/v5.json",
                "width": "container",
                "height": 600,
                "projection": {
                    "type": "equalEarth", 
                    "center": zoomSettings.center, 
                    "scale": zoomSettings.scale
                },
                "layer": [
                    // 1. OCEAN BACKGROUND - RUBRIC REQUIREMENT
                    {
                        "data": {"sphere": true},
                        "mark": {"type": "geoshape", "fill": "#d4e7f5", "stroke": "#b8d4e8"}
                    },
                    // 2. GRATICULE - RUBRIC REQUIREMENT
                    {
                        "data": {"graticule": {"step": [5, 5]}},
                        "mark": {"type": "geoshape", "fill": null, "stroke": "#b8d4e8", "strokeWidth": 0.5, "opacity": 0.6}
                    },
                    // 3. NEIGHBORING COUNTRIES - RUBRIC REQUIREMENT (Reference layer)
                    {
                        "data": {
                            "url": "https://cdn.jsdelivr.net/npm/world-atlas@2/countries-110m.json",
                            "format": {"type": "topojson", "feature": "countries"}
                        },
                        "mark": {"type": "geoshape", "fill": "#e8e8e8", "stroke": "#ffffff", "strokeWidth": 0.5}
                    },
                    // 4. MALAYSIA CHOROPLETH - Main visualization
                    {
                        "data": {
                            "url": "https://raw.githubusercontent.com/xiaofuhebadoan/Data-Visualization-2/main/malaysia_districts.json",
                            "format": {"type": "topojson", "feature": "my"}
                        },
                        "transform": [{
                            "lookup": "properties.name",
                            "from": {
                                "data": {"values": enhancedMapData},
                                "key": "state",
                                "fields": ["schools_per_10k", "income_mean", "poverty"]
                            }
                        }],
                        "mark": {"type": "geoshape", "stroke": "white", "strokeWidth": 1.5},
                        "encoding": {
                            "color": {
                                "field": getColorField(currentMapLayer),
                                "type": "quantitative",
                                "scale": getColorScale(currentMapLayer),
                                "legend": {
                                    "title": getLegendTitle(currentMapLayer), 
                                    "orient": "right",
                                    "titleFontSize": 13,
                                    "labelFontSize": 11
                                }
                            },
                            "tooltip": [
                                {"field": "properties.name", "type": "nominal", "title": "State"},
                                {"field": "schools_per_10k", "type": "quantitative", "title": "Schools per 10k", "format": ",.0f"},
                                {"field": "income_mean", "type": "quantitative", "title": "Avg Income (RM)", "format": ","},
                                {"field": "poverty", "type": "quantitative", "title": "Poverty Rate (%)", "format": ".1f"}
                            ]
                        }
                    },
                    // 5. STATE TEXT ANNOTATIONS - PEER FEEDBACK REQUIREMENT
                    {
                        "data": {
                            "values": [
                                {"state": "Selangor", "lon": 101.5, "lat": 3.1, "dx": -35, "dy": 0},
                                {"state": "Johor", "lon": 103.5, "lat": 1.9, "dx": 0, "dy": 10},
                                {"state": "Sarawak", "lon": 112, "lat": 2.5, "dx": 0, "dy": 0},
                                {"state": "Sabah", "lon": 116.5, "lat": 5.5, "dx": 0, "dy": 0},
                                {"state": "Pulau Pinang", "lon": 100.3, "lat": 5.4, "dx": -45, "dy": 0},
                                {"state": "Kelantan", "lon": 102.3, "lat": 5.8, "dx": 0, "dy": -10},
                                {"state": "Perak", "lon": 101.0, "lat": 4.6, "dx": -30, "dy": 5}
                            ]
                        },
                        "mark": {
                            "type": "text",
                            "fontSize": 14,
                            "fontWeight": "bold",
                            "fill": "#000000",
                            // "stroke": "#ffffff",
                            "strokeWidth": 2,
                            "opacity": 1
                        },
                        "encoding": {
                            "longitude": {"field": "lon", "type": "quantitative"},
                            "latitude": {"field": "lat", "type": "quantitative"},
                            "text": {"field": "state", "type": "nominal"},
                            "dx": {"field": "dx", "type": "quantitative"},
                            "dy": {"field": "dy", "type": "quantitative"}
                        }
                    }
                ]
            };
            
            return mapSpec;
        }
        
        // Resource efficiency scatter with FILTER - RUBRIC INTERACTIVITY
        function createEfficiencyScatter(minIncome) {
            const filteredData = enhancedMapData.filter(d => d.income_mean >= minIncome);
            
            return {
                "$schema": "https://vega.github.io/schema/vega-lite/v5.json",
                "width": "container",
                "height": 400,
                "autosize": {"type": "fit", "contains": "padding"},
                "data": {"values": filteredData},
                "mark": {"type": "circle", "size": 120, "opacity": 0.8},
                "encoding": {
                    "x": {
                        "field": "income_mean", 
                        "type": "quantitative", 
                        "title": "Average Monthly Income (RM)", 
                        "scale": {"zero": false}
                    },
                    "y": {
                        "field": "schools_per_10k", 
                        "type": "quantitative", 
                        "title": "Schools per 10,000 Population", 
                        "scale": {"zero": false}
                    },
                    "size": {
                        "field": "poverty", 
                        "type": "quantitative", 
                        "title": "Poverty Rate (%)", 
                        "scale": {"range": [80, 300]}
                    },
                    "color": {"value": colorSchemes.mediumBlue},
                    "stroke": {"value": colorSchemes.darkBlue},
                    "strokeWidth": {"value": 1},
                    "tooltip": [
                        {"field": "state", "type": "nominal", "title": "State"},
                        {"field": "income_mean", "type": "quantitative", "title": "Income (RM)", "format": ","},
                        {"field": "schools_per_10k", "type": "quantitative", "title": "Schools per 10k", "format": ",.0f"},
                        {"field": "poverty", "type": "quantitative", "title": "Poverty (%)", "format": ".1f"}
                    ]
                }
            };
        }
        
        // Teacher pressure scatter
        const teacherPressureData = [
            {state: "Selangor", ratio: 15.7, income: 12233, category: "High Pressure"},
            {state: "Kuala Lumpur", ratio: 15.4, income: 13325, category: "High Pressure"},
            {state: "Putrajaya", ratio: 14.9, income: 13473, category: "High Pressure"},
            {state: "Labuan", ratio: 14.1, income: 8250, category: "Medium Pressure"},
            {state: "Johor", ratio: 12.4, income: 8517, category: "Medium Pressure"},
            {state: "Pulau Pinang", ratio: 12.2, income: 8267, category: "Medium Pressure"},
            {state: "Terengganu", ratio: 11.2, income: 7248, category: "Balanced"},
            {state: "Sabah", ratio: 11.0, income: 6171, category: "Balanced"},
            {state: "Melaka", ratio: 11.0, income: 8057, category: "Balanced"},
            {state: "Kedah", ratio: 10.8, income: 5550, category: "Low Pressure"},
            {state: "Perak", ratio: 9.6, income: 5779, category: "Low Pressure"},
            {state: "Sarawak", ratio: 9.6, income: 6457, category: "Low Pressure"}
        ];
        
        const teacherPressureSpec = {
            "$schema": "https://vega.github.io/schema/vega-lite/v5.json",
            "width": "container",
            "height": 400,
            "autosize": {"type": "fit", "contains": "padding", "resize": true},
            "data": {"values": teacherPressureData},
            "mark": {"type": "circle", "size": 150},
            "encoding": {
                "x": {"field": "ratio", "type": "quantitative", "title": "Students per Teacher", "scale": {"zero": false}},
                "y": {"field": "income", "type": "quantitative", "title": "Average Income (RM)", "scale": {"zero": false}},
                "color": {
                    "field": "category", "type": "nominal", "title": "Pressure Level",
                    "scale": {
                        "domain": ["Low Pressure", "Balanced", "Medium Pressure", "High Pressure"],
                        "range": [colorSchemes.mediumBlue, colorSchemes.lightBlue, colorSchemes.darkOrange, colorSchemes.mediumRed]
                    }
                },
                "tooltip": [
                    {"field": "state", "type": "nominal", "title": "State"},
                    {"field": "ratio", "type": "quantitative", "title": "Students/Teacher", "format": ".1f"},
                    {"field": "income", "type": "quantitative", "title": "Income (RM)", "format": ","},
                    {"field": "category", "type": "nominal", "title": "Category"}
                ]
            }
        };
        
        // Timeline data
        const timelineData = [
            {year: 2017, metric: "Students", value: 4783438},
            {year: 2018, metric: "Students", value: 4791530},
            {year: 2019, metric: "Students", value: 4821723},
            {year: 2020, metric: "Students", value: 4823969},
            {year: 2021, metric: "Students", value: 4839261},
            {year: 2022, metric: "Students", value: 4821780},
            {year: 2017, metric: "Teachers", value: 423856},
            {year: 2018, metric: "Teachers", value: 438234},
            {year: 2019, metric: "Teachers", value: 428745},
            {year: 2020, metric: "Teachers", value: 435698},
            {year: 2021, metric: "Teachers", value: 437234},
            {year: 2022, metric: "Teachers", value: 434567}
        ];
        
        let currentTimelineYear = 2022;

        function createTimelineSpec() {
            const filteredData = timelineData.filter(d => d.year <= currentTimelineYear);
            
            return {
                "$schema": "https://vega.github.io/schema/vega-lite/v5.json",
                "width": "container", 
                "height": 350,
                "autosize": {"type": "fit", "contains": "padding"},
                "data": {"values": filteredData},
                "mark": {"type": "line", "point": true, "strokeWidth": 3},
                "encoding": {
                    "x": {"field": "year", "type": "ordinal", "title": "Year"},
                    "y": {"field": "value", "type": "quantitative", "title": "Count", "scale": {"zero": false}},
                    "color": {
                        "field": "metric", "type": "nominal", "title": "Metric",
                        "scale": {"range": [colorSchemes.textDark, colorSchemes.mediumBlue]}
                    },
                    "tooltip": [
                        {"field": "year", "type": "ordinal", "title": "Year"},
                        {"field": "metric", "type": "nominal", "title": "Metric"},
                        {"field": "value", "type": "quantitative", "title": "Count", "format": ","}
                    ]
                }
            };
        }
        
        // Gender data
        const genderData = [
            {stage: "Primary", gender: "Male", percentage: 51.3},
            {stage: "Primary", gender: "Female", percentage: 48.7},
            {stage: "Secondary", gender: "Male", percentage: 50.6},
            {stage: "Secondary", gender: "Female", percentage: 49.4},
            {stage: "Post-Secondary", gender: "Male", percentage: 42.7},
            {stage: "Post-Secondary", gender: "Female", percentage: 57.3}
        ];
        
        const genderSpec = {
            "$schema": "https://vega.github.io/schema/vega-lite/v5.json",
            "width": "container",
            "height": 220,
            "autosize": {"type": "fit", "contains": "padding", "resize": true},
            "data": {"values": genderData},
            "mark": "bar",
            "encoding": {
                "x": {"field": "percentage", "type": "quantitative", "stack": "normalize", "title": "Percentage"},
                "y": {"field": "stage", "type": "nominal", "title": "Education Stage"},
                "color": {
                    "field": "gender", "type": "nominal", "title": "Gender",
                    "scale": {"range": [colorSchemes.textDark, colorSchemes.mediumBlue]}
                },
                "tooltip": [
                    {"field": "stage", "type": "nominal", "title": "Stage"},
                    {"field": "gender", "type": "nominal", "title": "Gender"},
                    {"field": "percentage", "type": "quantitative", "title": "Percentage", "format": ".1f"}
                ]
            }
        };
        
        // Ethnicity data
        const ethnicityData = [
            {ethnicity: "Bumiputera Malay", percentage: 63.1},
            {ethnicity: "Chinese", percentage: 20.6},
            {ethnicity: "Indian", percentage: 6.2},
            {ethnicity: "Bumiputera Other", percentage: 7.8},
            {ethnicity: "Other", percentage: 2.3}
        ];
        
        const ethnicitySpec = {
            "$schema": "https://vega.github.io/schema/vega-lite/v5.json",
            "width": "container",
            "height": 220,
            "autosize": {"type": "fit", "contains": "padding", "resize": true},
            "data": {"values": ethnicityData},
            "mark": {"type": "arc", "innerRadius": 40},
            "encoding": {
                "theta": {"field": "percentage", "type": "quantitative"},
                "color": {
                    "field": "ethnicity", "type": "nominal", "title": "Ethnicity",
                    "scale": {
                        "range": [
                            colorSchemes.textDark, 
                            colorSchemes.mediumBlue, 
                            colorSchemes.lightBlue, 
                            colorSchemes.mediumOrange, 
                            colorSchemes.lightPurple
                        ]
                    }
                },
                "tooltip": [
                    {"field": "ethnicity", "type": "nominal", "title": "Ethnicity"},
                    {"field": "percentage", "type": "quantitative", "title": "Percentage", "format": ".1f"}
                ]
            }
        };
        
        // Age structure data
        const ageData = [
            {ageGroup: "0-14", percentage: 23.5},
            {ageGroup: "15-24", percentage: 13.4},
            {ageGroup: "25-54", percentage: 41.2},
            {ageGroup: "55+", percentage: 21.9}
        ];
        
        const ageSpec = {
            "$schema": "https://vega.github.io/schema/vega-lite/v5.json",
            "width": "container",
            "height": 220,
            "autosize": {"type": "fit", "contains": "padding", "resize": true},
            "data": {"values": ageData},
            "mark": {"type": "bar", "color": colorSchemes.textDark},
            "encoding": {
                "x": {"field": "ageGroup", "type": "ordinal", "title": "Age Group"},
                "y": {"field": "percentage", "type": "quantitative", "title": "Percentage of Population"},
                "tooltip": [
                    {"field": "ageGroup", "type": "nominal", "title": "Age Group"},
                    {"field": "percentage", "type": "quantitative", "title": "Percentage", "format": ".1f"}
                ]
            }
        };
        
        // Control functionality
        document.addEventListener('DOMContentLoaded', function() {
            // Map layer controls
            const mapControlBtns = document.querySelectorAll('[data-layer]');
            mapControlBtns.forEach(btn => {
                btn.addEventListener('click', function() {
                    mapControlBtns.forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    
                    currentMapLayer = this.dataset.layer;
                    const newMapSpec = createEnhancedMap();
                    vegaEmbed('#vis-enhanced-map', newMapSpec, {actions: false}).catch(console.error);
                });
            });

            // Zoom controls
            const zoomBtns = document.querySelectorAll('[data-zoom]');
            zoomBtns.forEach(btn => {
                btn.addEventListener('click', function() {
                    zoomBtns.forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    
                    currentZoom = this.dataset.zoom;
                    const newMapSpec = createEnhancedMap();
                    vegaEmbed('#vis-enhanced-map', newMapSpec, {actions: false}).catch(console.error);
                });
            });
            
            // Timeline slider
            const yearSlider = document.getElementById('year-slider');
            const sliderYearValue = document.getElementById('slider-year-value');

            yearSlider.addEventListener('input', function() {
                currentTimelineYear = parseInt(this.value);
                sliderYearValue.textContent = this.value;
                const newTimelineSpec = createTimelineSpec();
                vegaEmbed('#vis-timeline', newTimelineSpec, {actions: false}).catch(console.error);
            });

            // Income filter slider - NEW FOR RUBRIC
            const incomeSlider = document.getElementById('income-min-slider');
            const incomeValue = document.getElementById('income-min-value');

            incomeSlider.addEventListener('input', function() {
                currentMinIncome = parseInt(this.value);
                incomeValue.textContent = 'RM ' + currentMinIncome.toLocaleString();
                const newScatterSpec = createEfficiencyScatter(currentMinIncome);
                vegaEmbed('#vis-efficiency-scatter', newScatterSpec, {actions: false}).catch(console.error);
            });
            
            // Embed all visualizations initially
            vegaEmbed('#vis-enhanced-map', createEnhancedMap(), {actions: false}).catch(console.error);
            vegaEmbed('#vis-efficiency-scatter', createEfficiencyScatter(currentMinIncome), {actions: false}).catch(console.error);
            vegaEmbed('#vis-teacher-pressure', teacherPressureSpec, {actions: false}).catch(console.error);
            vegaEmbed('#vis-timeline', createTimelineSpec(), {actions: false}).catch(console.error);
            vegaEmbed('#vis-gender-pipeline', genderSpec, {actions: false}).catch(console.error);
            vegaEmbed('#vis-ethnicity', ethnicitySpec, {actions: false}).catch(console.error);
            vegaEmbed('#vis-age-structure', ageSpec, {actions: false}).catch(console.error);
        });
    </script>
</body>
</html>
